# XJSON (v1.1) - 项目计划

**本文件是 XJSON v1.1 开发的唯一真实来源。所有任务、进度和未来更新都将在此处跟踪。**

## 阶段一：核心引擎实现

*此阶段专注于构建库的基础组件。*

- [x] **任务 1.1：统一 `Node` 模型**
    - [x] 在 `xjson.go` 中定义 `Node` 接口。
    - [x] 在 `internal/engine/node.go` 中为所有 JSON 数据类型（对象、数组、字符串等）实现具体的 `Node` 类型。
    - [x] 确保所有节点类型共享一个通用的内部结构，以实现一致的错误处理和操作。
- [x] **任务 1.2：解析器实现**
    - [x] 在 `internal/parser/parser.go` 中实现核心解析逻辑。
    - [x] 暴露公共函数 `xjson.Parse(string) (Node, error)`。
  - [x] 编写单元测试（`internal/parser/parser_test.go`），覆盖有效的 JSON 和常见的语法错误。
- [x] **任务 1.3：可链式错误处理**
  - [x] 在内部 `Node` 结构体中添加一个 `error` 字段。
  - [x] 修改所有 `Node` 方法（`Get`、`Index` 等），以便在失败时检查并设置内部错误。
  - [x] 实现 `Error() error` 方法以返回第一个记录的错误。
  - [x] 编写单元测试以验证链式调用中的错误传播。

## 阶段二：查询与遍历

*此阶段实现主要的数据检索机制。*

- [x] **任务 2.1：基本查询方法**
  - [x] 为对象实现 `Get(key string)`。
  - [x] 为数组实现 `Index(i int)`。
  - [x] 确保无效操作（例如，对数组使用 `Get`）会记录适当的错误。
  - [x] 为成功和失败的情况编写全面的单元测试。
- [x] **任务 2.2：路径查询引擎 (`Query`)**
  - [x] 在 `internal/query/parser.go` 中创建路径解析器。
  - [x] 在 `internal/query/evaluator.go` 中创建路径评估器，以在 `Node` 树上执行已解析的路径。
  - [x] 支持嵌套路径 (`/a/b/c`) 和数组索引 (`/a/0/b`)。
  - [x] 确保不存在的路径返回一个空的 `Node` 并记录 `NotFound` 错误。

## 阶段三：路径函数

*此阶段引入 XJSON 的核心扩展功能。*

- [x] **任务 3.1：函数管理 API**
  - [x] 实现 `Func(name, fn)`、`CallFunc(name)` 和 `RemoveFunc(name)`。
  - [x] 在 `Node` 实现中添加一个函数注册表（例如 `map[string]func(Node) Node`）。
  - [x] 测试函数注册、调用和移除的完整生命周期。
- [x] **任务 3.2：路径语法扩展**
  - [x] 更新 `internal/query/parser.go` 中的路径解析器，以识别 `[@funcName]` 语法。
- [x] **任务 3.3：函数执行逻辑**
  - [x] 将函数执行集成到查询评估器（`internal/query/evaluator.go`）中。
  - [x] 编写结合路径查询和函数调用的集成测试。

## 阶段四：流式操作

*此阶段添加函数式数据处理能力。*

- [x] **任务 4.1：实现 `Filter`**
  - [x] 实现 `Filter(fn func(Node) bool) Node` 以从集合中选择元素。
- [x] **任务 4.2：实现 `Map`**
  - [x] 实现 `Map(fn func(Node) interface{}) Node` 用于数据转换。
- [x] **任务 4.3：实现 `ForEach`**
  - [x] 实现 `ForEach(fn func(int, Node))` 用于带副作用的迭代。

## 阶段五：写入操作

*此阶段添加数据修改功能。*

- [x] **任务 5.1：实现 `Set`**
  - [x] 实现 `Set(key string, value interface{}) Node` 以添加或更新对象字段。
- [x] **任务 5.2：实现 `Append`**
  - [x] 实现 `Append(value interface{}) Node` 以向数组添加元素。

## 阶段六：性能优化

*此阶段专注于提高执行速度和减少内存开销。*

- [x] **任务 6.1：原始值访问**
  - [x] 实现 `RawString()`、`RawFloat()` 等方法，以实现零拷贝数据访问。
- [x] **任务 6.2：路径缓存**
  - [x] 实现一个内部缓存，用于缓存已编译的查询路径，以加快重复调用的速度。
- [x] **任务 6.3：基准测试**
  - [x] 创建一个全面的基准测试套件（`benchmark_test.go`），以衡量关键操作的性能。

## 阶段七：文档和示例

*此阶段确保库文档完善且易于使用。*

- [x] **任务 7.1：API 文档**
  - [x] 为所有公共 API 编写完整的 GoDoc 注释。
- [x] **任务 7.2：最终确定 `readme.md`**
  - [x] 更新快速入门和所有代码示例，以反映最终的 API。
  - [x] 用更详细的示例扩展“用例”部分。
- [x] **任务 7.3：创建示例测试**
  - [x] 创建 `examples_test.go`，包含演示关键功能的可运行示例。

## 阶段八：最终测试和发布

*此阶段确保库稳定可靠。*

- [x] **任务 8.1：完整的单元测试覆盖率**
  - [x] 确保所有组件都有详尽的单元测试。
- [x] **任务 8.2：集成测试**
  - [x] 测试涉及多个组件协同工作的复杂场景。
- [x] **任务 8.3：错误处理测试**
  - [x] 验证所有可预见的失败场景都能被优雅地处理。
